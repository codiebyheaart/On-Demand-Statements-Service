@BeforeEach
void setUp() {
    try {
        mocks = MockitoAnnotations.openMocks(this);
        
        // Setup property loader ONLY
        Properties defaultProps = new Properties();
        defaultProps.put("od.maxHits", "100");
        defaultProps.put("odwek.tracelevel", "2");
        defaultProps.put("odNative_logonAndRetryOnException", "true");
        defaultProps.put("odNative_closeFolderOnReturnToPool", "false");
        when(mockPropertyLoader.getAppProperties()).thenReturn(defaultProps);
        
        // DON'T create static mock here!
        
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}

@AfterEach
void tearDown() throws Exception {
    if (mocks != null) {
        mocks.close();
    }
}

@Test
void testIngestReportToFolder_WhenAddThrowsException_EnsuresPoolCleanup() throws Exception {
    // Create static mock INSIDE the test with try-with-resources
    try (MockedStatic<CMODConnectionManager> cmodStatic = Mockito.mockStatic(CMODConnectionManager.class)) {
        
        // Setup the mock manager
        CMODConnectionManager mockManager = mock(CMODConnectionManager.class);
        cmodStatic.when(() -> CMODConnectionManager.getInstance()).thenReturn(mockManager);
        
        // Setup pool map
        Map<String, ODServerPool> poolMap = new HashMap<>();
        poolMap.put("testPortal", mockPool);
        when(mockManager.getPoolmap()).thenReturn(poolMap);
        
        // Setup pool behavior
        when(mockPool.borrowObject()).thenReturn(mockAbstractODServer);
        when(mockAbstractODServer.addReportToFolder(any(), any(byte[].class), any(), any(), any()))
                .thenThrow(new RuntimeException("DB error"));
        
        // Create ODServiceNative AFTER static mock is set up
        ODServiceNative service = new ODServiceNative(mockPoolConfig, mockPropertyLoader);
        
        // Act & Assert
        assertThrows(ODFailureException.class, () -> {
            service.ingestReportToFolder(
                    "testPortal", "client", "folder",
                    "Test".getBytes(), "group", "app",
                    new String[]{}, new Hashtable<>()
            );
        });
        
        verify(mockPool).borrowObject();
        verify(mockPool).returnObject(mockAbstractODServer);
    } // Static mock auto-closes here
}
