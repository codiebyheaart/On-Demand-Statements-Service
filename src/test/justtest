@Test
void testIngestReportToFolder_WhenAddThrowsException_EnsuresPoolCleanup() throws Exception {

    when(mockPool.borrowObject()).thenReturn(mockAbstractODServer);
    when(mockAbstractODServer.addReportToFolder(any(), any(), any(), any(), any()))
            .thenThrow(new RuntimeException("DB error"));

    CMODConnectionManager fakeMgr = mock(CMODConnectionManager.class);

    try (MockedStatic<CMODConnectionManager> mockedStatic =
            Mockito.mockStatic(CMODConnectionManager.class)) {

        mockedStatic.when(CMODConnectionManager::getInstance)
                .thenReturn(fakeMgr);

        when(fakeMgr.getODServerPool(any(), any(), any()))
                .thenReturn(mockPool);

        assertThrows(ODFailureException.class, () ->
                odServiceNative.ingestReportToFolder(
                        "testPortal", "client", "folder",
                        "Test".getBytes(), "group", "app",
                         new Hashtable<>()
                )
        );

        verify(mockPool).borrowObject();
        verify(mockPool).returnObject(mockAbstractODServer);
    }
}
